<!DOCTYPE html>
<html lang="en">

    <meta charset="utf-8">
    <title>MK217 FlightAssist</title>

	<!-- Leaflet CSS and JS -->
	<link rel="stylesheet" href="/static/HAIInterface/leaflet/leaflet.css"/>
	<script src="/static/HAIInterface/leaflet/leaflet.js"></script>
	<script src="/static/HAIInterface/leaflet/leaflet.rotatedMarker.min.js"></script>
	<script src="/static/HAIInterface/leaflet/leaflet-providers.js"></script>
    <script src="/static/HAIInterface/leaflet/Leaflet.Marker.SlideTo.js"></script>
	
    <!-- Ours -->
    <link rel="stylesheet" href="../static/HAIInterface/css/styling.css">
    <script src="/static/HAIInterface/JS/checklists.js"></script>
    <script src="/static/HAIInterface/JS/map.js"></script>
    <script src="/static/HAIInterface/JS/log.js"></script>
    <script src="/static/HAIInterface/JS/emergency.js"></script>
    <script src="/static/HAIInterface/JS/assistant.js"></script>
    <script src="/static/HAIInterface/JS/scheduler.js"></script>
    


    <!-- Socket IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js" integrity="sha512-HTENHrkQ/P0NGDFd5nk6ibVtCkcM7jhr2c7GyvXp5O+4X6O5cQO9AhqFzM+MdeBivsX7Hoys2J7pp2wdgMpCvw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    {% block imports %}
    {% endblock %}
    
    <style>

    .emergency-prompt {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 0, 0, 0.3);
    backdrop-filter: blur(8px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(255, 0, 0, 0.3);
    padding: 30px;
    z-index: 9999;
    color: white;
    text-align: center;
   
    transition: all 0.3s ease;
  }
  .emergency-prompt.low {
    background: rgba(254, 165, 1, 0.429);
    box-shadow: 0 0 20px rgba(255, 165, 0, 0.5);
    width: 500px;
  }

  .emergency-prompt.medium {
    background: rgba(255, 140, 0, 0.366);
    box-shadow: 0 0 25px rgba(255, 140, 0, 0.5);
    width: 600px;
  }
 
  .emergency-prompt.high {
    background: rgba(255, 0, 0, 0.3);
    box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
    width: 400px;
  }
  .emergency-header {
    font-size: 1.9em;
    font-weight: bolder;
    margin-bottom: 20px;
  }
  .flashing {
    animation: flash 1s infinite;
  }

  @keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.2; }
  }
  .emergency-body {
    font-size: 1.0em;
    margin-bottom: 25px;
  }
  .acknowledge-button {
    background: crimson;
    border: none;
    color: white;
    padding: 10px 20px;
    font-size: 1em;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .acknowledge-button:hover {
    background: darkred;
  }
  .emergency-siren {
    display: flex;
    align-items: center;
    justify-content: center;
    position: fixed;
    z-index: 9998;
    animation: pulse-siren 1.2s infinite;
  }

  @keyframes pulse-siren {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .hidden {
    display: none;
  }
  .visible {
    display: block;
  }
  .fade-out {
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  @keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.05); }
    100% { transform: translate(-50%, -50%) scale(1); }
  }

        .ai-button {
            position: relative;
            border: none;
            background: none;
            cursor: pointer;
            transition: transform 0.3s;
            z-index: 9999;
            margin-top: 3vh;
            padding: 2vh 2vw 2vh 2vw;
        }

        .ai-button img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
        }

        .ai-button:active {
            transform: scale(0.5);
        }

        /* Radio Panel */
        .radio-panel {
            background: #0f3460;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            width: 300px;
        }

        .radio-panel h2 {
            text-align: center;
        }

        .radio-button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            background: #e94560;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .radio-button:hover {
            background: #d13450;
        }

        .toggle-btn {
            background: #e94560;
            padding: 10px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.3s;
            width: 100%;
        }

        .toggle-btn:hover {
            background: #d13450;
        }

        {% block styling %}
        {% endblock %}        
    </style>

    <!--based on where we are in flight show the nearest/fastest helipad, nearest helipad with hospital facility, AI chooses. 
    Even if the human chooses evaluate the cognitive state to evaluate if their decision should be trusted --Carmen-->
    <body>        
        <div id="topbar" class="topbar">
            <div class="sidenav" onclick="hideMap()">
                <div class="sidenav-item-container">
                    <div id="preflight-sidebar" class="sidenav-item" style="border-left: 0;"><img src="../static/HAIInterface/img/PreFlight.png" width="60" height="60"><div>Preflight</div></div>
                    <div id="takeoff-sidebar" class="sidenav-item"><img src="../static/HAIInterface/img/TakeOff.png" width="60" height="60"><div>Takeoff</div></div>
                    <div id="cruise-sidebar" class="sidenav-item"><img src="../static/HAIInterface/img/CR.png" width="60" height="60"><div>Cruise</div></div>
                    <div id="approach-sidebar" class="sidenav-item"><img src="../static/HAIInterface/img/Approaching.png" width="60" height="60"><div>Approach</div></div>
                    <div id="landing-sidebar" class="sidenav-item" style="border-right: 0; border-radius:0 0 28px 0"><img src="../static/HAIInterface/img/Landing.png" width="60" height="60"><div>Land</div></div>
                </div>
            </div>

            <div class="system-title">
                MK217 Flight<b>Assist</b>
            </div>

            <div class="topnav">
                <div class="topnav-item" id='map' name='map' style="border-radius: 0px 0px 0px 30px;" onclick="showMap()">Map</div>
                <div class="topnav-item" id='help' name='help' >Help</div>
            </div>
        </div>
        
       <!-- Voice Assistant -->
        <div class="voice-assistant" id="assistant">
            <button id="aiToggle" class="ai-button">
                <div id="glowRing"></div>
                <div id="glowRingDelay" ></div>
                <img id="aiImage" src="../static/HAIInterface/img/robotic_bgrm.png" alt="AI Assistant">
                <div class="assistant-text" id="assistantText"></div>
            </button>
           
        </div>
        <!-- === VOICE FEEDBACK + COMMAND LOG === -->
        <div class="voice-feedback" id="voiceFeedback"></div>

       <div class="assistant-overlay">
        <div class="user-text-box" id="userTextBox" style="display: none;" >User Text Will Appear Here</div>
      </div>

    
    <script>
        const assistantNode = document.getElementById('vaJar');
        const assistantText = document.getElementById('assistantText');
        const feedbackBox = document.getElementById('voiceFeedback');
        const commandLog = document.getElementById('commandLog');

        function updateAssistantStatus(status) {
            assistantText.textContent = status;
        }

        function logCommand(userSaid, systemSaid) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<strong>You:</strong> "${userSaid}"<br><strong>AI:</strong> "${systemSaid}"`;
            commandLog.prepend(entry);
        }

        //  Trigger (example)
        assistantNode.addEventListener('click', () => {
            assistantNode.classList.add('active');
            updateAssistantStatus('Listening...');
            setTimeout(() => {
                updateAssistantStatus('Thinking...');
                setTimeout(() => {
                    updateAssistantStatus('Command received');
                    logCommand('Reroute to nearest helipad', 'Routing to nearest heliport');
                    setTimeout(() => {
                        assistantNode.classList.remove('active');
                        updateAssistantStatus('');
                    }, 3000);
                }, 2000);
            }, 2000);
        });
    </script>
    
    <style>
        .vaJar.focal {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(10, 10, 10, 0.6);
            padding: 10px;
            border-radius: 15px;
        }
    
        .jarvis-ring {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            cursor: pointer;
        }
    
        .glow-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 40%;
            box-shadow: 0 0 20px rgba(255, 106, 0, 0.4);
            animation: ringPulse 2s infinite;
        }
    
        .glow-ring.delay {
            animation-delay: 1s;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.2);
        }
    
        @keyframes ringPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
    
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
    
        .vaJar.active .glow-ring {
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
        }
    
        .assistant-text {
            margin-top: 10px;
            font-size: 1.1rem;
            color: #ffffff;
            font-weight: 600;
            text-shadow: 0 0 4px rgba(0, 224, 255, 0.4);
        }
    
        .voice-feedback {
            position: fixed;
            top: 170px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
    
        .command-log {
            position: fixed;
            top: 220px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-size: 0.9em;
            max-width: 300px;
            width: 90%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 9997;
        }
    
        .log-entry {
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 6px;
        }
    </style>



        <!--EMERGENCY PROMPT-->
        <div id="emergencyPrompt" class="emergency-prompt hidden">
            <div id="emergencyHeader" class="emergency-header flashing"></div>
            <div id="emergencyBody" class="emergency-body"></div>
            <button id="emok-button"class="acknowledge-button hidden" onclick="acknowledgeEmergency()">OK</button>
        </div>
        <div id="emergencySiren" class="emergency-siren hidden">
            <img src="../static/HAIInterface/img/siren.gif" width="150" height="150" alt="Siren">
        </div>

     
      
        <div id="center" class="center">
            {% block content %}
        
            {% endblock %}
        </div>    
    
        <div id="map-container" class="map-container" style="position:absolute">
            <!-- flightmap -->
            <div id="flightmap" class="flightmap"></div>
            <!-- central flash information -->
            <div id="flightmap-instruction" class="flightmap-instruction"><div>DOUBLE CLICK A HELIPAD TO SET THE DESTINATION</div></div>
            <!-- scroll instruction -->
            <div id="flightmap-scroll-instruction" class="map-scroll-instruction"><div>ZOOM USING<br>TWO FINGERS</div></div>
            <!-- Time to destination-->
            <div  id="dest-time" class="time"></div>
            <!-- bottom information bar -->
            <div id="bottom-nav" class="bottom-nav" onclick="hideMap()">
                <img id="bottom-nav-indicator" class="bottom-nav-indicator">
                <div class="bottom-nav-info-container">
                    <div class="bottom-nav-info">
                        <img class="bottom-nav-icon" src="../static/HAIInterface/img/helipad-icon.png">&ensp;
                        <div id="bottom-nav-name" style="font-weight: bold"></div>
                    </div>
                    <div class="bottom-nav-info">
                        <img class="bottom-nav-icon" src="../static/HAIInterface/img/location-icon.png">&ensp;
                        <div id="bottom-nav-address"></div>
                    </div>
                    <div class="bottom-nav-info">
                        <img class="bottom-nav-icon" src="../static/HAIInterface/img/institution-icon.png">&ensp;
                        <div id="bottom-nav-type"></div>
                        <div style="flex-grow: 1;"></div>
                        <div id="bottom-nav-nearest-heliport" class="bottom-nav-current-destination" style="background-color: seagreen">
                            NEAREST
                        </div>
                        <div id="bottom-nav-current-destination" class="bottom-nav-current-destination">
                            DESTINATION
                        </div>
                        <div id="bottom-nav-departure-heliport" class="bottom-nav-current-destination" style="background-color: lightcoral">
                            ORIGIN
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id= "vitals" style="display:none;" class="main-content-container vitals-popup">
            <div class="general-title" style="background-color: palegoldenrod;">Vitals Logging</div>
            <div class="subcontent-container">
                <div></div>
                <div class="index-text" style="font-size: 25pt;">Please log patient vitals now</div>
                <div class="index-text" style="font-size: 20pt;">Hit acknowledge AFTER you have submitted the vitals</div>&ensp;
                <div id="vitals-acknowledge-button" class="button">ACKNOWLEDGE</div>
            </div>
        </div>

        <div id="emergency" style="display:none; justify-content: space-between;"class="main-content-container vitals-popup">
            <img id='img_icon' src="../static/HAIInterface/img/alert.gif" width="150" height="150">
            <div class="index-text emergency-text" id="blink" style="color: red; background-color: rgb(223, 154, 94);">UNFAVORABLE WEATHER CONDITIONS</div><br>
            <div class="index-text emergency-text" style="color: white;">MUST LAND IMMEDIATELY</div>
            <div></div>
            <div class="index-text emergency-text" style="color: whitesmoke;">Continue to select an emergency location</div>
            <div></div>
            <div id="emergency-acknowledge-button" class="button">CONTINUE</div>
        </div>

        

        <!-- Radio Comms  -->
        <div id="radiopanel"  class="radiopanel">
            <button class="radiopanel-closebtn" >&times;</button>
                <h2>Radio Communication</h2>
                <label for="callsign">Callsign:</label>
                <select id="callsign">
                    <option value="" disabled selected>Select Callsign</option>
                    <option value="NASXGS">NASXGS</option>
                    <option value="MEDEVAC">MEDEVAC</option>
                </select>
                <br><br>
                <div class="radio-group">
                    <p>Select Radio:</p>
                    <div class="radio-options">
                        <label>
                            <input type="radio" name="radio-select" value="Nav1">
                            <span>NAV1</span>
                        </label>
                        <label>
                            <input type="radio" name="radio-select" value="Nav2">
                            <span>NAV2</span>
                        </label>
                        <label>
                            <input type="radio" name="radio-select" value="Comm1">
                            <span>COMM1</span>
                        </label>
                        <label>
                            <input type="radio" name="radio-select" value="Comm2">
                            <span>COMM2</span>
                        </label>
                    </div>
                </div>
                <label for="frequency-input">Frequency:</label>
                <div class="frequency-control">
                    <button class="frequency-btn" onclick="changeFrequency(-0.05)">-</button>
                    <input type="text" id="frequency-display" value="123.45" readonly>
                    <button class="frequency-btn" onclick="changeFrequency(0.05)">+</button>
                </div>
                <br><br>

                <div class="controls">
                    <button onclick="grdupdate()" class="transmit-btn">Transmit COMM1</button>
                    <button onclick="grdcontact()" class="receive-btn">Transmit COMM2</button>
                </div>


        </div>
     
        <button class="openbtn" ></button> 

        <!-- Pressure Warning  -->
        <div class="alertoverlay" id="pressureWarningalertOverlay">
            <div class="alert-box" id="pressureWarningalertBox"> 
              <div class="engine-failure" id="warningText">Low Pressure Warning!</div>
              <div class="warning-sign">
                <img src="../static/HAIInterface/img/warning-sign.png" class="siren-gif" alt="warning-sign">
              </div>
              <button class="alert-button" id="pressureWarningmoreInfoButton" onclick="showInfo()">Click for more info</button>
              <div id="pressureWarningalertExplanation" style="display: none;">
                <p>Report the value shown by the backup hydraulic sensor:</p>
                <div id="resultMessage" style="display: none;"></div>
                <!-- <div class="input-box"> -->
                  <select id="pressureValue" class="input-field" >
                    <option value="" selected disabled>select pressure value</option>
                    <option value="71">71</option>
                    <option value="72">72</option>
                    <option value="73">73</option>
                    <option value="74">74</option>
                    <option value="75">75</option>
                    <option value="76">76</option>
                    <option value="77">77</option>
                    <option value="78">78</option>
                    <option value="79">79</option>
                    <option value="80">80</option>
                  </select>
                <!-- </div> -->
                 <br><br>
                <button class="submit-button" onclick="submitPressureValue()">Submit</button>
              </div>
              <div id="finalMessage" style="display: none;"></div>
              <button class="ok-button" id="ok-Button" style="display: none;" onclick="closePressureAlert()">OK</button>
            </div>
             <audio id="warningSound" >
                <source src="../static/HAIInterface/img/warning-sound.mp3" type="audio/mpeg">
             </audio> 
          </div>

       
       <!-- Engine Failure Emergency    -->  
       <div class="alertbody">
        <div class="alertoverlay" id="alertOverlay">
           <div class="alert-box" id="alertBox">
             <div class="engine-failure" id="engineFailureText"> 🚨 <strong>ENGINE FAILURE!</strong></div>
             <div class="warning-sign">
                <img src="../static/HAIInterface/img/siren.gif" class="siren-gif" alt="Siren">
             </div>
             <div>Need to land Immediately</div>
            <!--  <button class="alert-button" id="moreInfoButton" onclick="showMoreInfo()">Click for more info</button>
              <button class="close-button" id="closeButton" onclick="closeAlert()">X</button> 
             <div id="alertExplanation" style="display: none;"> -->
            <!-- <ul style="list-style-type:circle; padding: 15px; text-align: justify; ">
            <li><b>Alert:</b> Engine failure detected. This is not a drill.</li>
                <li><b>Action Required:</b> Initiating emergency procedures now.</li> 
                <li><b>Immediate Task:</b> We need to select an alternate landing site.</li>
                <li><b>Your Input Needed: </b>Use the button below to choose an emergency landing location.</li> 
                <li><b>Recommendation: </b>I suggest landing at Hilton Gardern Inn Heliport, the nearest available site.</li> 
                <li><b>Map Guide:</b> Look for the green marker on the map - that's our closest option.</li> 
                <li><b>Additional Support:</b>  Assistance from Control is available if you deem it necessary.</li> 
                <li><b>Time Sensitive:</b> Swift action is crucial for our safety.</li>
            </ul>

            </div> -->
            <button class="submit-button" style="display: none;" id="CDButton">Emergency Landing</button>
          </div>
        </div>        
       <audio id="sirenSound" >
           <source src="../static/HAIInterface/img/audio.mp3" type="audio/mpeg">
       </div>
        
       <!-- Fuel Tank Emergency    -->
       <div class="alertbody">
         <div class="alertoverlay" id="fuelAlertOverlay">
            <div class="alert-box" id="fuelAlertBox">
              <div class="engine-failure" id="emptyTankText"> ⚠️ Fuel Gauge Alert</div>
              <div class="warning-sign">
                <img src="../static/HAIInterface/img/empty-tank.png" class="siren-gif" alt="empty-tank"> 
              </div>
            <p><strong>Detected:</strong> Fuel gauge reads empty</p>
            <p><strong>Diagnostics:</strong>
                Fuel flow <span class="status-check">✅</span>,
                Engine <span class="status-check">✅</span>
            </p>
            <p><strong>Recommendation:</strong> Continue flight unless instructed otherwise</p>
            <p>Status: Under continuous monitoring</p>
            <p><strong>Medic Options:</strong></p>
            <button class="ok-button" id="okFuel-Button" style="display: none;">OK</button>&ensp;&ensp;
            <button class="ok-button" id="elFuel-Button">Change Destination</button>
           
              <!-- <button class="alert-button" id="fuelInfoButton" onclick="showFuelInfo()">Click for more info</button>
              <div id="fuelAlertExplanation" style="display: none;">
                <ul style="list-style-type:circle; padding: 15px; text-align: justify; ">
                    <li><b>Fuel Gauge Alert:</b> My primary fuel gauge is indicating an empty tank. </li>
                    <li><b>Gauge Reliability:</b> There's a high probability this reading is inaccurate.</li>
                    <li><b>Confidence Level: </b>I am 95% certain we have sufficient fuel on board.</li>
                    <li><b>Safety Assessment:</b> Based on my calculations, it is safe to continue our flight.</li>
                    <li><b>Backup Systems:</b> A reserve fuel tank is available if needed.</li>
                    <li><b>Current Plan:</b> I intend to maintain our planned route and destination unless requested otherwise.</li> 
                    <button class="ok-button" id="okButtonFuel" style="display: none;">Continue as planned</button>
                    <li style="max-width:max-content"><b>Alternate Options:</b></li>  
                 </ul>
                    <button class="ok-button" id="elButtonFuel" >Change Destination</button>&ensp;&ensp;
                    <button class="ok-button" id="groundButtonFuel" >Contact Control</button>  -->
               </div>
            </div>
         </div>        
        <audio id="emptytankSound" >
            <source src="../static/HAIInterface/img/audio.mp3" type="audio/mpeg">
         </audio> 
        </div>

         
         <!-- Report altitude Value  -->
         <div class="alertoverlay" id="altitudealertOverlay">
            <div class="alert-box" id="altitudealertBox"> 
              <div class="engine-failure" id="altitudeText"> Sensor Miscalibrated!</div>
              <div class="warning-signn">
                <img src="../static/HAIInterface/img/warning-sign.png" class="siren-gif" alt="warning-sign">
              </div>
              <button class="alert-button" id="altitudemoreInfo-Button" onclick="showAltitudeInfo()">Click for more info</button>
              <div id="altitudealertExplanation" style="display: none;">
                <p>Report the value shown by the backup Altitude  sensor:</p>
                  <select id="altitudeValue" class="input-field" >
                    <option value="" selected disabled>select altitude</option>
                    <option value="1000">1000</option>
                    <option value="1100">1100</option>
                    <option value="1200">1200</option>
                    <option value="1300">1300</option>
                    <option value="1400">1400</option>
                    <option value="1500">1500</option>
                  </select>
                 <br><br>
                <button class="submit-button" onclick="submitAltitudeValue()">Submit</button>
              </div>
              <div id="finalMessage" style="display: none;"></div>
              <button class="ok-button" id="ok-Button" style="display: none;" onclick="closeAltitudeAlert()">OK</button>
            </div>
             <audio id="altitudeSound" >
                <source src="../static/HAIInterface/img/warning-sound.mp3" type="audio/mpeg">
             </audio> 
          </div>


       <div class="alertoverlay" id="showAlert-button">
            <div class="alert-box" id="altitudeTimeBox">
                <div class="warning-sign">
                <p>⚠️ <strong> Alert:</strong> Altitude Change </p>
                <p>Suggested Change: Increase altitude (+5 min travel time)</p>
                <button class="submit-button" id="acceptChange-Button" onclick="acceptChange()">✅ Accept Route Change</button>
                <button class="submit-button" id="ignoreChange-Button"onclick="ignoreChange()">❌ Ignore</button>
                </div>
            </div>
        </div>


        <!-- <div class="alert critical">
            <p>🚨 <strong>ENGINE FAILURE!</strong> Emergency landing required.</p>
            <p>Landing Site Options:</p>
            <button onclick="landNow()">🛬 Land (15 min, limited care)</button>
            <button onclick="continueFlight()">✈️ Continue (25 min, full care)</button>
        </div> -->

        <!-- Weather Emergency    -->  
       <div class="alertbody">
        <div class="alertoverlay" id="weatheralertOverlay">
           <div class="alert-box" id="weatheralertBox">
             <div class="engine-failure" id="engineFailureText"> UNFAVORABLE WEATHER!</div>
             <div class="warning-sign">
                <img src="../static/HAIInterface/img/siren.gif" class="siren-gif" alt="Siren">
             </div>
             <button class="alert-button" id="weathermoreInfoButton" onclick="showMoreWeatherInfo()">Click for more info</button>
            
             <div id="weatheralertExplanation" style="display: none;">
                 <ul style="list-style-type:circle; padding: 15px; text-align: justify; ">
                    <li><b>Alert:</b> Bad Weather Conditions.</li>
                     <li><b>Action Required:</b> Initiating emergency procedures now.</li> 
                     <li><b>Immediate Task:</b> We need to select an alternate landing site.</li>
                      <li><b>Recommendation: </b>I suggest landing at Hilton Gardern Inn Heliport, the nearest available site.</li> 
                      <li><b>Map Guide:</b> Look for the green marker on the map - that's our closest option.</li> 
                      <li><b>Time Sensitive:</b> Swift action is crucial for our safety.</li>
                      <li><b>Your Input Needed: </b>Please say "Jarvis, Change Destination" to choose an emergency landing location.</li> 
                      <li><b>Additional Support:</b> Assistance from Control is available if you deem it necessary.</li> 
                 </ul>

            </div>
             <!-- <button class="close-button" id="weathercloseButton" onclick="closeWeatherAlert()">Close</button>  -->
            <!-- <button class="submit-button" style="display: none;" id="weatherCDButton">Emergency Landing</button>  -->
            <button class="submit-button" style="display: none;" id="weathercloseButton" onclick="closeWeatherAlert()">Close</button> 
          </div>
        </div>        
       <audio id="weathersirenSound" >
           <source src="../static/HAIInterface/img/audio.mp3" type="audio/mpeg">
        </audio> 
       </div>
        
            
    </body>

    <script>
        const socket = io.connect("http://localhost:8080");

        var userId = "none"
        var studyStage = -1
        var decisionState = 0
        var vitalsState = 0
        var airspaceState = 0
        var destinationIndex = 3 //Emory University 
        var departureIndex = -1
        var latitude = 33.6595539 //Miller Farm 
        var longitude = -84.6629889
        var compass = 0
        var resetUserDisplay = 0
        var satisfied = false
        var warningSatisfied = false
        var weatherSatisfied=false
        var altitudeSatisfied = false
        var destChanged = false
        var timeToDestination=11.0
        var selectedmarker="none"
        var emergencyPage=0
        var CAPage=0
        var CDPage=0
        var RDPage=0
        var mapPage=0
        var radioPage=0
        

        // this var isn't updated by the server, but can be changed on various pages
        let emergencyState = 0
        let targetIndex = -1
        let EngineFailure = 0
        let PressureWarning = 0
        let weatherEmergency=0
        let altitudeAlert=0
        let EmptyTank = 0
        var radioTransmit=0
        var radioReceive=0
        var takeOffMatlab=0
        var approachClearMatlab=0
        let lastTaskCompleted = null;  // Track which secondary task was completed last
        let tasks = ['radioUpdate', 'vitalsUpdate'];  // List of secondary tasks
        const radioInterval = 105000; // Total cycle time: 1 min + 45 sec = 105 sec
        let last_radio_update = 0;

        

        // initialize the map
	    var planeMarker, map, mapSelection
        var setDestination = false;
	    initMap()

        initEmergency()
        TimeToDestination() 
        initAssistant()
        //schedulePrompt()

        
        var helipads = JSON.parse('{{ helipads | tojson | safe }}')
        let helipadsLoaded = false  // flag automatically set to true (so helipads only load once, after we know where the origin and current destination are)
        let currentFrequency = 123.45;

        document.querySelector('.openbtn').addEventListener('click', function() {
           logAction({"action": "radio panel opened"})
            console.log('clicked')
            document.querySelector('.radiopanel').classList.toggle('open');
            });

        document.querySelector('.radiopanel-closebtn').addEventListener('click', function() {
           logAction({"action": "radio panel closed"})
            document.querySelector('.radiopanel').classList.remove('open');
            });

        if (radioPage==1){
           logAction({"action": "radio panel opened by controller"})
            console.log('clicked by controller')
            document.querySelector('.radiopanel').classList.toggle('open');
        }


        function changeFrequency(step) {
            const frequencyDisplay = document.getElementById('frequency-display');
            let currentFrequency = parseFloat(frequencyDisplay.value);
            currentFrequency += step;
            currentFrequency = Math.max(118.00, Math.min(121.95, currentFrequency));  // Ensure frequency stays within valid range (118.00 to 121.95)
            frequencyDisplay.value = currentFrequency.toFixed(2);
          logActionAction({"action": "frequency input set to"+ currentFrequency })
        }
        

        function grdupdate() {
            const callsign = document.getElementById('callsign').value;
           logAction({"action": "transmit button pressed"})
           logAction({"action": `callsign set to: + ${callsign}`})

            if(callsign!="NASXGS"){
                // alert('Select correct Callsign for transmitting ')
                const dialog = document.createElement('dialog');
                    dialog.innerHTML = `
                    <p>Select correct Callsign for transmitting updates</p>
                    <button onclick="this.closest('dialog').close()">OK</button>
                    `;
                    document.body.appendChild(dialog);
                    dialog.showModal();
            }
            else{
                const Frequency = document.getElementById('frequency-display').value
                if(!Frequency){
                    // alert("Set Frequency")
                    const dialog = document.createElement('dialog');
                    dialog.innerHTML = `
                    <p>Set Frequency</p>
                    <button onclick="this.closest('dialog').close()">OK</button>
                    `;
                    document.body.appendChild(dialog);
                    dialog.showModal();
                    
                }
                else{
                const radio = document.querySelector('input[name="radio-select"]:checked');
                if (radio.value== "Comm1") {
                   logAction({"action": "radio set to:"+ radio.value})
                    showMap()
                    //alert(`${callsign} transmitting on ${radio.value} ${currentFrequency.toFixed(2)} MHz`);
                    const dialog = document.createElement('dialog');
                    dialog.innerHTML = `
                    <p>${callsign} transmitting updates on ${radio.value} ${currentFrequency.toFixed(2)} MHz</p>
                    <button onclick="this.closest('dialog').close(), hideMap()">Close</button>
                    `;
                    document.body.appendChild(dialog);
                    dialog.showModal();
                    radioTransmit=1
                    fetch("/var?transmit=" + radioTransmit) 
                   logAction({"action": callsign+"transmitting updates on" + radio.value + (currentFrequency.toFixed(2))+" MHz" })
                } 
                else {
                    //alert('Select a radio channel');
                    const dialog = document.createElement('dialog');
                    dialog.innerHTML = `
                    <p>Select a radio channel for transmitting updates</p>
                    <button onclick="this.closest('dialog').close()">OK</button>
                    `;
                    document.body.appendChild(dialog);
                    dialog.showModal();
                }
                }
          } if (radioTransmit==1){
                setTimeout(() => {
                 radioTransmit=0
                 fetch("/var?transmit=" + radioTransmit) 
                }, 20000)  // wait 20 seconds to set is back to 0
            }
        }


        
        function grdcontact() {
            const callsign = document.getElementById('callsign').value;
           logAction({"action": "receive button pressed"})
           logAction({"action": "callsign set to:"+{callsign}})

            if(callsign!="MEDEVAC"){
                //alert('Select receiving callsign')
                const dialog = document.createElement('dialog');
                    dialog.innerHTML = `
                    <p>Select correct Callsign for contacting Control</p>
                    <button onclick="this.closest('dialog').close()">OK</button>
                    `;
                    document.body.appendChild(dialog);
                    dialog.showModal();
            }
            else{
                const Frequency = document.getElementById('frequency-display').value
                if(!Frequency){
                    //alert("Set Frequency")
                    const dialog = document.createElement('dialog');
                    dialog.innerHTML = `
                    <p>Set Frequency</p>
                    <button onclick="this.closest('dialog').close()">OK</button>
                    `;
                    document.body.appendChild(dialog);
                    dialog.showModal();
                }
                else{
                    const radio = document.querySelector('input[name="radio-select"]:checked');
                    if (radio.value== "Comm2") {
                       logAction({"action": "radio set to:"+ radio.value})
                        //alert(`${callsign} receiving on ${radio.value} ${currentFrequency.toFixed(2)} MHz`);
                        const dialog = document.createElement('dialog');
                        dialog.innerHTML = `
                        <p>${callsign} contacting Control on ${radio.value} ${currentFrequency.toFixed(2)} MHz</p>
                        <button onclick="this.closest('dialog').close()">Close</button>
                        `;
                        document.body.appendChild(dialog);
                        dialog.showModal();
                       logAction({"action": callsign+"transmitting on" + radio.value + (currentFrequency.toFixed(2))+" MHz" })
                        this.timeoutID=setTimeout(() => {radioReceive=1
                        fetch("/var?receive=" + radioReceive) 
                        clearTimeout(this.timeoutID)
                         }, 5000)  // wait 5 seconds to send to server
                        
                } 
                else {
                    // alert('Radio channel for Receiving missing or incorrect');  
                    const dialog = document.createElement('dialog');
                    dialog.innerHTML = `
                    <p>'Radio channel for contacting Control missing or incorrect'</p>
                    <button onclick="this.closest('dialog').close()">OK</button>
                    `;
                    document.body.appendChild(dialog);
                    dialog.showModal();
                }
                }
          }
          if (radioReceive==1){
                setTimeout(() => {
                    radioReceive=0
                 fetch("/var?receive=" + radioReceive) 
                }, 20000)  // wait 30 seconds to set is back to 0
            }
        }

        //updateFrequencyDisplay();
        document.getElementById("map").addEventListener('mapClicked', function(event) {
            console.log('mapClicked event heard');
            showMap();
        });


        // Toggle AI Assistant Activation
        const aiToggle = document.getElementById("aiToggle");
            const aiImage = document.getElementById("aiImage");
            const glowRing = document.getElementById("glowRing");
            const glowRingDelay = document.getElementById("glowRingDelay");
            const aiButton = document.querySelector(".ai-button"); 

            const aiInactiveImage = "../static/HAIInterface/img/robotic_bgrm.png";
            const aiActiveGif = "../static/HAIInterface/img/robotic_bgrm.gif";

            //const toggleSound = new Audio("../static/HAIInterface/sound/activate.mp3");


            let aiActive = false;

        aiToggle.addEventListener("click", function () {
            aiActive = !aiActive;
            aiImage.src = aiActive ? aiActiveGif : aiInactiveImage;

            // Toggle pulsating effect
            if (aiActive) {
                    glowRing.classList.add("glow-ring");
                    //glowRing.classList.add("delay");
                    aiButton.classList.add("active");
                    updateAssistantStatus('Listening...');
                    //toggleSound.currentTime = 0;  // reset in case it's still playing
                    //toggleSound.play();
                    //document.body.classList.add('assistant-dull-background', 'active');
                } else {
                    aiButton.classList.remove("active");
                    //glowRing.classList.remove("glow-ring");
                    glowRing.classList.add("delay");
                    updateAssistantStatus('');
                    //document.body.classList.remove('assistant-dull-background', 'active');

                }
            });



        /* function acceptChange(){
            console.log('change accepted-changing altitude')
                const altitudeTimeOverlay = document.getElementById('altitudeTimeOverlay');
                altitudeTimeOverlay.style.opacity = '0';
                altitudeTimeOverlay.addEventListener('transitionend', () => {
                    altitudeTimeOverlay.style.visibility = 'hidden';
                    document.body.classList.remove('dull-background');
                }, { once: true });
                vitalsState = 0
                console.log(vitalsState);
                //updating the server
                await fetch("/var?vitals-state=" + vitalsState)
               logAction({ "page": "Inflight", "action": "Change altitude button on vitals emergency pressed" });
                window.location.href = '/hai-interface/ca-page=' + 1 ;
        }


        function ignoreChange(){
                console.log('ignore change-not change altitude')
                const altitudeTimeOverlay = document.getElementById('altitudeTimeOverlay');
                altitudeTimeOverlay.style.opacity = '0';
                altitudeTimeOverlay.addEventListener('transitionend', () => {
                    altitudeTimeOverlay.style.visibility = 'hidden';
                    document.body.classList.remove('dull-background');
                }, { once: true });
                vitalsState = 0
                console.log(vitalsState);
                //updating the server
                await fetch("/var?vitals-state=" + vitalsState)  
               logAction({ "page": "Inflight", "action": "Ignore change button on vitals emergency pressed" });
            }
 */

            function validateLowInput() {
                const input = document.getElementById('lowInput');
                const feedback = document.getElementById('lowFeedback');
                const correctValue = 3000; // expected correct value
                const prompt = document.getElementById('emergencyPrompt');
                const siren = document.getElementById('emergencySiren');

                if (parseInt(input.value) === correctValue) {
                    text="Acknowledged. Secondary sensor confirms normal pressure. This appears to be a sensor miscalibration. No action required. System status: Normal."
                    speakJarvis(text,"normal")
                    const infoBox = document.createElement('div');
                    infoBox.textContent = `Sensor was miscalibrated <br> Warning cleared`;
                    infoBox.style.position = 'fixed';
                    infoBox.style.top = '50%';
                    infoBox.style.left = '50%';
                    infoBox.style.transform = 'translateX(-50%)';
                    infoBox.style.backgroundColor = 'rgba(128, 255, 0, 0.3)';
                    infoBox.style.backdropFilter = "blur(8px)";
                    infoBox.style.color = '#fff';
                    infoBox.style.padding = '25px 35px';
                    infoBox.style.borderRadius = '15px';
                    infoBox.style.boxShadow = '0 0 15px rgba(0,0,0,0.3)';
                    infoBox.style.zIndex = '10000';
                    document.body.appendChild(infoBox);

                    prompt.classList.add('fade-out');
                    setTimeout(() => {
                        prompt.classList.add('hidden');
                    }, 500); // delay to match the fade-out animation
                setTimeout(() => {
                    document.body.removeChild(infoBox);
                }, 8000);
            } else {
                feedback.textContent = 'Incorrect value. Please report the correct reading.';
                feedback.style.color = '#e74c3c';
                speakJarvis("Incorrect value. Please report the correct reading", "normal")
            }
}

            function showEmergencyPrompt(level, title, message) {
                const prompt = document.getElementById('emergencyPrompt');
                const header = document.getElementById('emergencyHeader');
                const body = document.getElementById('emergencyBody');
                const siren = document.getElementById('emergencySiren');
                const okbutton= document.getElementById('emok-button');

                header.innerHTML = `${level === 'low' ? '⚠️' : '🚨'} ${title}`;

                if (level === 'low') {
                    text="Primary hydraulic gauge shows low pressure. Please report the current reading from the secondary sensor."
                    speakJarvis(text, "normal")
                    body.innerHTML = `
                    <p>${message}</p>
                    <input id="lowInput" name="valueInput" type="number" placeholder="Enter reading" style="padding: 20px; font-size: 0.8em; margin-top: 12px; width: 80%;">
                    <br><button onclick="validateLowInput()" id="submit-button" class="acknowledge-button" style="margin-top: 12px;">Submit</button>
                    <div id="lowFeedback" style="margin-top: 12px; color: #fff;"></div>`;
                } else if (level === 'medium') {
                    text = "Primary Fuel gauge is indicating empty, but system diagnostics confirm normal fuel flow and engine performance. This appears to be a sensor malfunction. No immediate action is required. I will keep monitoring the situation closely while continuing the mission as planned unless instructed otherwise."
                    speakJarvis(text, "mild")
                    body.innerHTML = `
                    <p><strong style="color: black;">Detected:</strong> Fuel gauge reads empty</p>
                    <p><strong style="color: black;">Diagnostics:</strong> False Warning
                    </p>
                    <p><strong style="color: black;">Recommendation:</strong> Continue flying as planned</p>
                    <p><strong style="color: black;">Options:</strong></p>
                    <button class="ok-button" id="okFuel-Button">OK</button>&ensp;&ensp;
                    <button class="ok-button" id="elFuel-Button">Change Destination</button>`;
                } else {
                    text = "Emergency detected: Engine on fire. Immediate landing is required. Nearest helipad is a commercial Helipad X. I recommend landing there. Please confirm Helipad X or select an alternative emergency landing site."
                    speakJarvis(text, "high")
                    body.innerHTML = message;
                    okbutton.classList.remove('hidden');
                }

                prompt.classList.remove('hidden', 'low', 'medium', 'high');
                prompt.classList.add(level);

                
                }

            function acknowledgeEmergency() {
                const prompt = document.getElementById('emergencyPrompt');
                if (!prompt.classList.contains('high')) return;
                prompt.classList.add('fade-out');
                setTimeout(() => {
                    prompt.classList.add('hidden');
                }, 500);
                const siren = document.getElementById('emergencySiren');
                siren.classList.add('visible');
                siren.style.right = '60px';
                siren.style.top = '25%';
                siren.style.position = 'fixed';
            }
    

        //Listen to the socket for any changes from the controller:
        socket.on("update_callsign", (data) => {   // Callsign updates from the control panel
            console.log("Callsign update received:", data.callsign);
           logAction({ "page": "radio-panel", "action": "callsign changed to " + data.callsign });
            document.getElementById("callsign").value = data.callsign;
        });
        
        socket.on("update_channel", (data) => {    // Channel updates from the control panel
            console.log("Channel update received:", data.channel);
           logAction({ "page": "radio-panel", "action": "channel changed to " + data.channel });

            let radioOptions = document.querySelectorAll("input[name='radio-select']");
            radioOptions.forEach(radio => {
                if (radio.value === data.channel) {
                    radio.checked = true;
                }
            });
        });

        socket.on("update_transmit", (data) => {   // Transmit updates from the control panel
            console.log("Transmit update received:", data.transmit);
           logAction({ "page": "radio-panel", "action": "transmit command received: " + data.transmit });
            if (data.transmit == "1") {
                grdupdate(); //  for Transmit Comm1
            } else if (data.transmit == "2") {
                grdcontact(); // Calls the receive function for Transmit Comm2
            }
        });

        socket.on("speak_text", (data) => {   // Text to be spoken  from the control panel
            console.log("Receieved text and stress level:", data.text, data.stress_level);
            logAction({ "page": "speak text", "action": "Receieved text and stress level:"+ data.text+ data.stress_level});
            speakJarvis(data.text, data.stress_level)
        });

        function speakJarvis(message, stress_level){
                const voices = window.speechSynthesis.getVoices();
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.voice = voices[2];  //for firefox
                utterance.rate = 1.0; //all these variables as per firefox
                if (stress_level == "normal") {
                    utterance.pitch = 1.0;
                    utterance.volume = 0.7;
                }
                else if (stress_level == "mild") {
                    utterance.pitch = 1.5;
                    utterance.volume = 0.7;
                 }
                else {
                    utterance.rate = 1.4;
                    utterance.pitch = 2.0;
                    utterance.volume = 1.0;
                  }
                window.speechSynthesis.speak(utterance);

        }
           


     
        socket.on("execute_command", (data) => {
            //const {action, elementId, value} = data;
            console.log(data)
            console.log(`Executing: ${data.action} on ${data.whichbtn} with value: ${data.value}`);
            logAction({"action": `Controller Executing: ${data.action} on ${data.whichbtn} with value: ${data.value}`});
            const action=data.action

            const element = document.getElementById(data.whichbtn) || document.querySelector(`[name='${data.whichbtn}']`);

            if (!element) {
                console.warn(`Element ${data.whichbtn} not found.`);
                return;
            }

            switch (action) {
                case "click":
                    element.click();
                    break;
                case "show":
                    const altitudeTimeOverlay = document.getElementById('showAlert-button');
                    document.body.classList.add('dull-background');
                    altitudeTimeOverlay.style.visibility = 'visible';
                    altitudeTimeOverlay.style.opacity = '1';
                case "set-value":
                    if (["INPUT", "TEXTAREA", "SELECT"].includes(element.tagName)) {
                        element.value = data.value;
                    }
                    break;
                
            }
        });

       // Examples of triggering emergencies
        //showEmergencyPrompt('low', 'Low Pressure Warning', '<div> Report the reading from the secondary hydraulic pressure gauge</div>');
        //showEmergencyPrompt('medium', 'Fuel Tank Empty', 'Empty Fuel tank warning detected. Pilot attention required.');
         //showEmergencyPrompt('high', 'Engine Fire', `<div>Need to <strong>Land immediately</strong></div><br><div>Pick an emergency landing site</div>`);
        //showEmergencyPrompt('high', 'Weather Emergency', '<strong>Severe turbulence detected.</strong><br>Prepare for emergency descent.');

        {% block script %}
        {% endblock %}
    </script>

</html>     

