{% extends "HAIInterface/layout.html" %}

<body>
{% block content %}
<audio id="myAudio">
	<source src="../static/HAIInterface/img/audio.mp3" type="audio/mpeg">
</audio>

<audio id="bell">
	<source src="../static/HAIInterface/img/bell.mp3" type="audio/mpeg">
</audio>

<div id="main" class="main-content-container">
	<div id ='title' class="general-title">Inflight Control</div>
	<div class="subcontent-container" style="flex-grow: 1; justify-content: space-evenly;">
	 <div class="inflight-button-grid">
		<div id="emergency-landing" class="grid-button emergency-landing ">Emergency Landing</div>
		<div id="return-departure" class="grid-button return-departure">Return to Departure Location</div>
		<div id="change-destination"  class="grid-button change-destination">Change Destination</div>
		<div id="change-altitude"  class="grid-button change-altitude">Change Altitude</div>
	 </div>
	</div>

</div>

{% endblock %}
</body>

<script>
{% block script %}
	var HelpId=4;
	let lastClicked = Infinity
	let radioCompletetime=0
	const myTimeout=0
	let TargetIndex = 100
	var audio = document.getElementById("myAudio"); 
	var bell = document.getElementById("bell"); 
	document.getElementById('help').onclick = () => { log({"page": "Inflight", "action": "help button pressed"}); window.location.href = '/hai-interface/help?num=' + HelpId }
	document.getElementById("emergency-landing").onclick = () => { log({"page": "Inflight", "action": "emergency landing button pressed"}); window.location.href = '/hai-interface/change-destination?inflight=' + 1 + '&emergency=' + 1 }
	document.getElementById("return-departure").onclick = () => {  log({"page": "Inflight", "action": "return to departure button pressed"}); window.location.href = '/hai-interface/location?inflight=' + 1 + '&dest=' + 21 }
	document.getElementById("change-destination").onclick = () => {  log({"page": "Inflight", "action": "change destination button pressed"}); window.location.href = '/hai-interface/change-destination?inflight=' + 1 }
	document.getElementById("change-altitude").onclick = () => { log({"page": "Inflight", "action": "change altitude button pressed"}); window.location.href = '/hai-interface/change-altitude?Changed_altitude='+ 1500 }


	document.getElementById('help').href='/hai-interface/help?num='+HelpId
	document.getElementById('map').href = '/hai-interface/map'
	document.getElementById('cruise-sidebar').style.backgroundColor = "pink"


	// vitals reminder, onclick for the vital reminder done button
	document.getElementById("vitals-acknowledge-button").onclick = () => {
		log({"page": "inflight", "action": "user acknowledged vitals prompt"})
		console.log('vitals logging acknowledged')
		document.getElementById('vitals').style.display = "none"
		bell.pause()	
		//console.log("vitals completed time:", lastClicked)
		
	} 

	//fetch from server for emergency?
	function vitalsLogging() {
	 if(vitalsState==0 && EngineFailure == 0 && PressureWarning == 0 &&  EmptyTank == 0 && timeToDestination>0.5){
		var curr = new window.Date().getTime()
		//console.log("lastclicked:", lastClicked)
		//console.log("radiocompletetime".radioCompletetime)
		console.log("vitals time:", curr)
		
		//if( radioCompletetime - curr > 135000 ){  // 135s assuming 30s logging+ 30s gap + 45s radio update + 30s gap
		log({"page": "inflight", "action": "displaying vitals prompt"})
		console.log('vitals logging prompt')
		lastClicked = new window.Date().getTime()
		//lastClicked = Infinity  
		document.getElementById('vitals').style.display = "flex"
		bell.play()
		//setInterval(bell.play(), 300);  //delayimg sound
		bell.volume=0.2;
		//send request to clear radio update after vitals done
		
	
	 	}
	}
	/* async function fetchRadioData() {
		try {
			const response = await fetch("/state", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json' 
				},
				body: JSON.stringify({ event: 'Radio-Update-status'}), 
			});
	
			if (!response.ok) {
				throw new Error(`HTTP error: ${response.status}`);
			}
	
			const radiodata = await response.json();
			if (radiodata["radioUpdateComplete"]){
				console.log('Radio Update Completed')
				 this.timeoutID = setTimeout(() => {
					radioCompletetime=new window.Date().getTime()
					console.log("calling vitals logging")
					vitalsLogging()
					clearTimeout(this.timeoutID)
					console.log("Timeout cleared")
				},45000) //after 45 seconds
				//send request to clear radio update
				const Radioresponse = await fetch("/state", {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json' 
						},
						body: JSON.stringify({ event: 'radioUpdateComplete', action: 'clear'}), 
					});
				console.log('Clear Radio Update event request sent')
				//consle.log(typeof this.timeoutID)
				/* if (typeof this.timeoutID==="number"){
					clearTimeout(this.timeoutID)
					console.log("Timeout cleared")
				} 
			} 
		} catch (err) {
			console.error('Fetch problem: ${err.message}');
		}
	} 
	setInterval(fetchRadioData, 350);   */


	const radioInterval = 105000; // Total cycle time: 1 min + 45 sec = 105 sec
	let radioPromptSpokenAt = 0;
	var landingChecklistTime=timeToDestination- 30000; // Stop 30s before end

		// On flight start
		window.onload = () => {
			window.flightStartTime = Date.now();
			scheduleRadioPrompt();
		};

		// Speak radio prompt
		function scheduleRadioPrompt() {
			const now = Date.now();

			speakRadioPrompt();
			radioPromptSpokenAt = now;

			// Schedule vitals prompt after 60s
			setTimeout(() => {
				const elapsed = Date.now() - window.flightStartTime;
				if (elapsed < landingChecklistTime) {
					showVitalsPrompt();
				}
			}, 60000);

			// Schedule next radio prompt after 105s
			setTimeout(scheduleRadioPrompt, radioInterval);
		}

		// Use browser speech synthesis for radio prompt
		function speakRadioPrompt() {
			const message = "Please provide a radio communication update.";
			const utterance = new SpeechSynthesisUtterance(message);
			utterance.rate = 1;
			utterance.pitch = 1;
			utterance.volume = 1;
			window.speechSynthesis.speak(utterance);
		}

		// Show vitals prompt visually
		function showVitalsPrompt() {
			log({ "page": "inflight", "action": "displaying vitals prompt" })
			console.log('vitals logging prompt') 
			document.getElementById('vitals').style.display = "flex"
			bell.play()
			bell.volume = 0.2;

			// Auto-remove after 10s
			setTimeout(() => {
				document.getElementById('vitals').style.display = "none"
			}, 10000);
		}

		
	// Initial fetch
	//fetchRadioData();  

	// interval for the inflight stage- want the radio updates and vitals prompt to show up at regular intervals when emergency not occuring such that both don't overlap
	/* setInterval(() => {
		const response = await fetch("/speak", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
			},
			body: JSON.stringify({ type: "radioUpdate"}), 
		});
		if (!response.ok) {
			throw new Error(`HTTP error: ${response.status}`);
		}
		const json = await response.json();
		
		radio_update_complete= json.radioUpdateComplete
			
		
		
		 
	}}, 1000) */

{% endblock %}
</script>
