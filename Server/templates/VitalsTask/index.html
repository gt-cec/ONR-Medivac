<!DOCTYPE html>
<html>
    <!-- import CSS -->
    <head>
        <title>HAI Vitals Logger Pro</title>
        <link rel="stylesheet" href="../../static/VitalsTask/styles.css"/>
        <script src="../../static/VitalsTask/vitals.js"></script>
        <script src="../../static/HAIInterface/JS/scheduler.js"></script>
        <audio id="bell">
            <source src="../../static/HAIInterface/img/bell.mp3" type="audio/mpeg">
        </audio>
        <style>
            :root {
            --primary-color: #0C2D48;
            --secondary-color: #145DA0;
            --accent-color: #2E8BC0;
            --text-primary: #E8F1F2;
            --text-secondary: #B1D4E0;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --gauge-bg: rgba(30, 39, 46, 0.6);
            --panel-bg: rgba(12, 30, 48, 0.92);
            --border-radius: 12px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }

        .left-pane {
            width: 430px;
            height: 90vh;
            overflow: hidden;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            background-color: var(--primary-color);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.4);
        }

        /* ===== GAUGE PANEL STYLES ===== */
        .gauge-panel {
            position: relative;
            height: 50%;
            width: 100%;
            background-color: var(--panel-bg);
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            box-sizing: border-box;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            /*  overflow hidden to prevent content spillover */
            overflow: hidden;
        }

        .gauge-container {
            position: relative;
            width: 65%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1px 0;
            /* Reduce padding to fit all gauges */
            margin-bottom: 0;
        }

        .gauge-label {
            text-align: center;
            margin-bottom: 0px;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .gauge-inner {
            position: relative;
            width: 100%;
            padding-top: 40%;
            
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .arc-bg {
            fill: none;
            stroke-width: 10; 
            stroke: var(--gauge-bg);
        }

        .arc-fg {
            fill: none;
            stroke-width: 10; 
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke 0.3s ease, stroke-dashoffset 0.8s ease;
        }

        #fuelArc {
            stroke: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
        }

        #altitudeArc {
            stroke: var(--accent-color);
        }

        #pressureArc {
            stroke: #9b59b6;
        }

        .pointer {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 2px;
            height: 45%;
            background-color: white;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            border-radius: 2px;
            transition: transform 0.8s ease;
            z-index: 2;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }

        .gauge-value {
            font-size: 15px;
            color: #f1c40f;
            text-align: center;
            margin-top: 3px; 
            font-weight: bolder;
        }

        .fuel-warning {
            position: absolute;
            top: -10px;
            background-color: red;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
            animation: flash 1s infinite;
            z-index: 3;
        }

        .hidden {
            display: none;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /*RADIO PANEL */
        .bottom {
            height: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            box-sizing: border-box;
           
        }

        .radiopanel {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background-color: var(--panel-bg);
            padding: 5px;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            box-sizing: border-box;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            overflow: hidden;
           
        }

        .panel-title {
            text-align: center;
            font-size: 17px;
            margin-bottom: 8px;
            color: var(--text-primary);
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: bolder;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }

        .panel-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px; 
        }

        .panel-row:last-child {
            margin-bottom: 0;
        }

        .radiopanel label {
            font-size: 16px;
            padding: 3px 0; 
            text-align: left;
            color: var(--text-secondary);
            margin-bottom: 3px; 
            font-weight: bold;
        }

        

        .radiopanel select,
        .radiopanel input[type="text"] {
            background-color: rgba(46, 49, 56, 0.8);
            color: var(--text-primary);
            padding: 8px; 
            border: 1px solid rgba(74, 93, 126, 0.5);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .radiopanel select:focus,
        .radiopanel input[type="text"]:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 139, 192, 0.25);
        }

        .radio-group .radio-options {
            display: flex;
            gap: 5px;
            justify-content: space-between;
            font-size: 13px;
            
        }

        .radio-options label {
            flex: 1 1 22%;
            background-color: rgba(46, 59, 79, 0.7);
            padding: 8px 3px; 
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: var(--text-secondary);
            margin-top: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .radio-options label:hover {
            background-color: rgba(59, 76, 100, 0.8);
            transform: translateY(-2px);
        }

        .radio-options input[type="radio"] {
            position: absolute;
            opacity: 0;
           
        }

        .radio-options input[type="radio"]:checked + span {
            background-color: var(--accent-color);
            color: white;
            border-radius: 4px;
            padding: 2px 4px; 
            box-shadow: 0 0 10px rgba(46, 139, 192, 0.5);
        }

        /* Frequency Control */
        .frequency-control {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px;
            width: 100%;
            margin: 0px;
        }

        label[for="frequency-input"] {
            margin-bottom: 3px; 
            display: block;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .frequency-btn {
            width: 32px; 
            height: 32px; 
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .frequency-btn:hover {
            background-color: #3aa8e0;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .frequency-btn:active {
            transform: scale(0.95);
        }

        #frequency-display {
            width: 150px; 
            padding: 4px;
            font-weight: 500;
            font-size: 16px;
            text-align: center;
            background-color: rgba(30, 40, 56, 0.8);
            color: #4fc3f7;
            border: 1px solid rgba(74, 93, 126, 0.5);
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .controls {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 5px; 
            margin-top: 4px; 
            width: 100%;
        }

        .controls button {
            flex: 1 1 48%;
            font-size: 16px; 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin-top: 0%;
             
        }

        .transmit-btn {
            background-color: var(--success-color);
        }

        .transmit-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .receive-btn {
            background-color: var(--danger-color);
        }

        .receive-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .feedback {
            text-align: center;
            font-size: 16px;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            visibility: hidden;
            height: 0;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .feedback.success {
            visibility: visible;
            height: auto;
            background-color: rgba(46, 204, 113, 0.2);
            color: #2eccc1;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .feedback.error {
            visibility: visible;
            height: auto;
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        /* Transmit Animation */
        .transmit-animation {
            position: fixed;
            bottom: 60px;
            left: 30px;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, rgba(46, 204, 113, 0.8) 20%, transparent 70%);
            border-radius: 50%;
            opacity: 0;
            animation: none;
            z-index: 999;
        }

        @keyframes transmitPulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.8); opacity: 0.4; }
            100% { transform: scale(3); opacity: 0; }
        }

        .dialogue-box {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(30, 30, 47, 0.95);
            border: 3px solid #4caf50;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 9999;
            font-size: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .dialogue-box button {
            margin-top: 10px;
            padding: 2px 3px;
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        
            .right-pane {
                width: 77%;
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            .horizontal-container {
                display: flex;
                flex: 1;
            }
            .vertical-container {
                display: flex;
                flex-direction: column;
                flex: 1;
            }
            .iframe-container {
                width: 100%;
                height: 100%;
                border: none;
                overflow: hidden;
            }

            div.vitals-popup {
                z-index: 9999;
                width: 60vw;
                height: 50vh;
                top: 25%;
                left:25%;
                align-self: center;
                box-shadow: 2px 2px 5px grey;
                background-color: palevioletred;
            }

            div.subcontent-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                flex-grow: 1;
                padding: 2vh 0 2vh 0;
                background-color: #fff5ec;
                border: 2px solid lightgrey;
                border-radius: 10px;
                margin: 3vh;
            }

            div.general-title {
                color: darkslategrey;
                font-size:50px;
                margin-top: 3vh;
                padding: 2vh 2vw 2vh 2vw;
                background-color: #dcb9ff;
                font-weight: bold;
                border-top: 2px solid lightgrey;
                border-bottom: 2px solid lightgrey;
                text-align: center;
            }

            div.general-text {
                color:rgb(0, 0, 0);
                font-size:30px;
            }
            div.index-text {
                font-size:30pt;
            }
            .vitals-ack-button {
            flex-grow: 0;
            background-color: #12d429; 
            border: 2px solid lightgrey;
            color: whitesmoke;
            padding: 23px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 40px;
            margin-bottom: 2vh;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 2px 2px 5px grey;
            font-weight: bolder;
            width: 30vw;
            align-self: center;
        }
        div.main-content-container {
            display:flex;
            flex-direction: column;
            border: 2px solid lightgrey;
            border-radius: 7px;
            margin: 5vh;
            flex-grow: 1;
            height: 50%;
            z-index: 9999;
            position: absolute;
        }


        </style>
    </head>
    
    <!-- main content -->
    <body>
        <div class="main-pane">
            <div class="left-pane">
                <!-- Gauge Panel Section -->
                <div class="gauge-panel">
                    <div class="gauge-container" id="fuelGauge">
                        <div class="fuel-warning hidden" id="fuelWarning">⚠ EMPTY</div>
                        <div class="gauge-label">Fuel</div>
                        <div class="gauge-inner">
                            <svg viewBox="0 0 200 120">
                                <path class="arc-bg" d="M 10 100 A 90 90 0 0 1 190 100" />
                                <path class="arc-fg" id="fuelArc" d="M 10 100 A 90 90 0 0 1 190 100" style="stroke: #2ecc71;" />
                            </svg>
                            <div class="pointer" id="fuelPointer"></div>
                        </div>
                        <div class="gauge-value" id="fuelValue">100%</div>
                    </div>
            
                    <div class="gauge-container" id="altitudeGauge">
                        <div class="gauge-label">Altitude</div>
                        <div class="gauge-inner">
                            <svg viewBox="0 0 200 120">
                                <path class="arc-bg" d="M 10 100 A 90 90 0 0 1 190 100" />
                                <path class="arc-fg" id="altitudeArc" d="M 10 100 A 90 90 0 0 1 190 100" style="stroke: #3498db;" />
                            </svg>
                            <div class="pointer" id="altitudePointer"></div>
                        </div>
                        <div class="gauge-value" id="altitudeValue">0 ft</div>
                    </div>
            
                    <div class="gauge-container" id="pressureGauge">
                        <div class="gauge-label">Pressure</div>
                        <div class="gauge-inner">
                            <svg viewBox="0 0 200 120">
                                <path class="arc-bg" d="M 10 100 A 90 90 0 0 1 190 100" />
                                <path class="arc-fg" id="pressureArc" d="M 10 100 A 90 90 0 0 1 190 100" style="stroke: #9b59b6;" />
                            </svg>
                            <div class="pointer" id="pressurePointer"></div>
                        </div>
                        <div class="gauge-value" id="pressureValue">14.7 psi</div>
                    </div>
                </div>
            
                <!-- Radio Communication Panel -->
                <div class="bottom">
                    <div id="radiopanel" class="radiopanel">
                        <h2 class="panel-title">Radio Communication</h2>
            
                        <div class="panel-row">
                            <label for="callsign">Callsign</label>
                            <select class="callsign" id="callsign">
                                <option value="" disabled selected>Select</option>
                                <option value="NASXGS">NASXGS</option>
                                <option value="MEDEVAC">MEDEVAC</option>
                            </select>
                        </div>
            
                        <div class="panel-row radio-group">
                            <label>Select Radio</label>
                            <div class="radio-options">
                                <label class="radio-options label"><input type="radio" name="radio-select" value="Nav1"><span>NAV1</span></label>
                                <label class="radio-options label"><input type="radio" name="radio-select" value="Nav2"><span>NAV2</span></label>
                                <label class="radio-options label"><input type="radio" name="radio-select" value="Comm1"><span>COMM1</span></label>
                                <label class="radio-options label"><input type="radio" name="radio-select" value="Comm2"><span>COMM2</span></label>
                            </div>
                        </div>
            
                        <div class="panel-row">
                            <label for="frequency-input">Frequency</label>
                            <div class="frequency-control">
                                <button class="frequency-btn" onclick="changeFrequency(-0.05)">-</button>
                                <input type="text" id="frequency-display" value="123.45" readonly>
                                <button class="frequency-btn" onclick="changeFrequency(0.05)">+</button>
                            </div>
                        </div>
            
                        <div class="panel-row controls">
                            <button onclick="grdupdate()" class="transmit-btn">Updates</button>
                            <button onclick="grdcontact()" class="receive-btn">Emergency</button>
                        </div>
            
                        <div id="radio-feedback" class="feedback"></div>
                        <div id="connection-dialogue" class="dialogue-box" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="right-pane">
                <div class="vertical-container">
                    <div class="title-pane">
                        <i><b>HAI</b></i>&ensp;Vitals Logger&nbsp;<b>Pro</b>
                    </div>
                    <div class="horizontal-container">
                        <div id="menu-pane" class="menu-pane">
                            <div id="vitals" style="display:none;" class="main-content-container vitals-popup">
                                <div class="general-title" style="background-color: palegoldenrod;">Vitals Logging</div>
                                <div class="subcontent-container">
                                    <div></div>
                                    <div class="index-text" style="font-size: 25pt;">Please log patient vitals now</div>
                                    <div class="index-text" style="font-size: 20pt;">Hit acknowledge AFTER you have submitted the vitals</div>&ensp;
                                    <div id="vitals-acknowledge-button" class="vitals-ack-button">ACKNOWLEDGE</div>
                                </div>
                            </div>
                            <!-- buttons -->
                            <div class="vertical-container">
                                <!-- separate the sensor buttons and the submit button -->
                                <div class="vertical-container">
                                    <button id="heartrate-button" onclick="setSensor('Heart Rate')" class="menu">Heart Rate</button>
                                    <button id="o2-button" onclick="setSensor('O₂ Saturation')" class="menu">O₂ Saturation</button>
                                    <button id="bloodpressure-button" onclick="setSensor('Blood Pressure')" class="menu">Blood Pressure</button>  
                                </div>
                                <div class="vertical-container" style="flex:.2">
                                    <!-- timer countup -->
                                    <div id="submit-timer" class="action-text" style="border-bottom:none">0:00</div>
                                    <button id="submit-button" onclick="submit()" class="submit" style="background-color:#86ffbf">Submit</button>
                                </div>
                            </div>
                        </div>
                        <div id="action-pane" class="action-pane">
                            <!-- buttons -->
                            <div id="action-sensor-text" class="action-text">Heart Rate</div>
                            <div id="keypad-container" class="keypad-container">
                                <div id="keypad-value" class="keypad-value">0</div>
                                <div id="keypad" class="keypad"></div>
                            </div>
                            <div id="action-button-container" style="flex-direction: column;">
                                <button id="action-capture-button" onclick="recordVital('capture')" class="menu action-button"><div id="action-capture-button-text" class="button-text"></div><div id="action-capture-button-loading-bar" class="button-loading-bar"></div></button>
                                <button id="action-log-button" onclick="recordVital('log')" class="menu action-button"><div id="action-log-button-text" class="button-text"></div><div id="action-log-button-loading-bar" class="button-loading-bar"></div></button>
                                <button id="action-save-button" onclick="recordVital('save')" class="menu action-button"><div id="action-save-button-text" class="button-text"></div><div id="action-save-button-loading-bar" class="button-loading-bar"></div></button>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
        </div>

        <!-- Transmit Animation Icon -->
        <div id="transmit-animation" class="transmit-animation"></div>
        
        <!-- Audio Elements -->
        <audio id="radio-static" src="sounds/radio-static.mp3" preload="auto"></audio>
        <audio id="radio-beep" src="sounds/beep.mp3" preload="auto"></audio>
    </body>

    <script>
        // variables
        let sensors = ["Heart Rate", "O₂ Saturation", "Blood Pressure"]  // used as a lookup, does not set the HTML
        let actions = ["capture", "log", "save"]  // used as a lookup, does not set the HTML
        let currentSensor = ""
        let checklist = {}
        let countupTimerStart = Date.now()
        let countupTimerWarningRed = 110  // warn the user when timer has been ignored for 100 seconds, but turning it red
        let countupTimerWarningStart = countupTimerWarningRed - 10  // when the countup timer background starts changing color
        let vitalsLog = {}
        let preTrialWindow
        
        let inProgress = false;  // whether a sensor collection is in progress -- is blocking
        let showingKeypad = false;  // whether the keypad is being shown -- block changing

        // colors
        let heartRateButtonColor = "#d3e8d0" //"#ffb9bb"
        let heartRateBackgroundColor = "#edffec" //"#ffeced"
        let o2ButtonColor = "#b9bbff"
        let o2BackgroundColor = "#ecedff"
        let bloodPressureButtonColor = "#ffb9bb" // "#fffdb9"
        let bloodPressureBackgroundColor = "#ffeced" // "#fffeec"

        document.getElementById("heartrate-button").style.backgroundColor = heartRateButtonColor
        document.getElementById("o2-button").style.backgroundColor = o2ButtonColor
        document.getElementById("bloodpressure-button").style.backgroundColor = bloodPressureButtonColor

        // initialization
        generateKeypad()
        resetVitalsLog()
        resetChecklist()
        setSensor("Heart Rate")
        startCountupTimer()
        showKeypad()
        showActionButtons()


        //polling from the server every 5 secs, giving post trial after landing
        setInterval(async function get_variables() {
            let response = await fetch("/var");
            let message = await response.text();
            message = JSON.parse(message);
            if (message["decision-state"]==1)
            {
                window.location.href = '/vitals/post-trial'
            }

            //pre-trial
            if (message["pre-trial"]==1){
                    preTrialWindow = window.open("https://gatech.co1.qualtrics.com/jfe/form/SV_9NxIuNdiOdhxAwK", "_blank")
                    await fetch("/var?pre-trial=0")
            }

            //post-trial
            if (message["post-trial"]==1){
                    postTrialWindow = window.open("https://gatech.co1.qualtrics.com/jfe/form/SV_be0lJqrd0InXxCm", "_blank")
                    await fetch("/var?post-trial=0")
            }

            if (message["reset-vitals-display"] == "1") {
                await fetch("/var?reset-vitals-display=0")
                preTrialWindow.close();
                postTrialWindow.close();
                window.location.href = "/vitals"
            }

    
        }, 5000);

        

      let currentPhase = "ground";
        let frequency = 123.45;
        let lastValues = { pressure: 0, altitude: 0, fuel: 0 };

        function changeFrequency(amount) {
                const freqDisplay = document.getElementById("frequency-display");
                let freq = parseFloat(freqDisplay.value);
                freq += amount;
                freq = Math.max(108.00, Math.min(136.00, freq)); // VHF typical range
                freqDisplay.value = freq.toFixed(2);
            }

            function simulateConnection() {
                return Math.random() > 0.1; // 90% chance of success
            }

            function showFeedback(message, type) {
                const feedback = document.getElementById("radio-feedback");
                feedback.textContent = message;
                feedback.className = 'feedback ' + (type === 'success' ? 'success' : 'error');
                // Clear after 10 seconds
                setTimeout(() => {
                    feedback.textContent = '';
                    feedback.className = 'feedback'; // reset to base class if needed
                }, 10000); 
            }

            function playSound(id) {
                const sound = document.getElementById(id);
                if (sound) {
                    sound.currentTime = 0;
                    sound.play();
                }
            }

            function startTransmitAnimation() {
                const anim = document.getElementById('transmit-animation');
                anim.style.animation = "transmitPulse 1s ease-out forwards";
                anim.style.opacity = 1;

                setTimeout(() => {
                    anim.style.animation = "none";
                    anim.style.opacity = 0;
                }, 1000);
            }

           function showConnectionDialogue(message) {
                const container = document.getElementById("connection-dialogue");
                container.innerHTML = `
                <div class="dialogue-box">
                    <p>${message}</p>
                    <button onclick="endTransmission()">Stop Transmission</button>
                </div>`;
                container.style.display = "block";
            }

            function endTransmission() {
                const container = document.getElementById("connection-dialogue");
                container.style.display = "none";
                showFeedback("Transmission ended.", "success");
            }

            function handleRadioTransmission(expectedCallsign, expectedChannel, successMessage) {
                    const callsignInput = document.getElementById("callsign");
                    const selectedRadio = document.querySelector('input[name="radio-select"]:checked');

                    if (!callsignInput || !callsignInput.value.trim()) {
                        showFeedback("Callsign is missing.", "error");
                        return;
                    }

                    if (!selectedRadio) {
                        showFeedback("Radio channel is not selected.", "error");
                        return;
                    }

                    const callsign = callsignInput.value.trim();
                    const channel = selectedRadio.value.trim();

                    if (callsign !== expectedCallsign) {
                        showFeedback("Invalid callsign entered.", "error");
                        return;
                    }

                    if (channel.toUpperCase() !== expectedChannel.toUpperCase()) {
                        showFeedback("Incorrect radio channel selected.", "error");
                        return;
                    }
                    const isConnected = simulateConnection();
                    playSound("radio-static");

                    if (isConnected) {
                    playSound("radio-beep");
                    showConnectionDialogue(successMessage);
                    startTransmitAnimation();
                    } else {
                    showFeedback("Failed to establish connection. Try again.", "error");
                     }
            }

        function grdupdate() {
                handleRadioTransmission("NASXGS", "COMM1", "Transmitting to Ground Station (NASXGS on COMM1)....");
        }

        function grdcontact() {
            handleRadioTransmission("MEDEVAC", "COMM2", "Emergency Contact Initiated (MEDEEVAC on COMM2)....");
        }
            
          
        function updateNeedle(id, value, max, minAngle, maxAngle) {
            const ratio = Math.min(value / max, 1);
            const angle = minAngle + ratio * (maxAngle - minAngle);
            document.getElementById(id).style.transform = `rotate(${angle}deg)`;
        }

       

        let takeoffTime = null;
        let landingCountdownStarted = false;

        /* function fetchFlightData() {
            fetch("/var")
                .then(res => res.json())
                .then(data => {
                    if (data.takeoff && !takeoffTime) {
                        currentPhase = "takeoff";
                        takeoffTime = Date.now();
                    } else if (takeoffTime && Date.now() - takeoffTime > 5000 && currentPhase === "takeoff") {
                        currentPhase = "cruise";
                    }

                    if (data["approach-clear"] && currentPhase !== "descent") {
                        currentPhase = "descent";
                        if (!landingCountdownStarted) {
                            landingCountdownStarted = true;
                            setTimeout(() => currentPhase = "landing", 30000);
                        }
                    }

                   updateGauge(fuel, "fuelArc", "fuelPointer", "fuelValue", '%', 100, "fuel");
                    updateGauge(altitude, "altitudeArc", "altitudePointer", "altitudeValue", ' ft', MAX_ALTITUDE, "altitude");
                    updateGauge(pressure, "pressureArc", "pressurePointer", "pressureValue", ' psi', NORMAL_PRESSURE, "pressure");
                })
                .catch(err => console.error("Failed to fetch /var:", err));
        }

        setInterval(fetchFlightData, 2000);
 */
    let vitalsEmergency=false

    setInterval(async function fetchVitalstate() {
        let response = await fetch("/var");
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
           
        let message = await response.text();
        message = JSON.parse(message);
        if(message["takeoff"] == 1 && !(message["prompt-cycle-started"] == true || message["prompt-cycle-started"] == "true")){
            console.log("Starting prompt cycle")
            logAction({ "action": "Starting prompt cycle" })
            checkAndStartPromptCycle();
            startTakeoff()
        }
        if (message["approach_clear"] == 1 )
         {
            checkAndStartPromptCycle(stopCycle=true);
            beginDescent()
         }
        if (message["vitals-state"]==1)
        {
          updateAltitude()  //altitude change for vitals emergency
          vitalsEmergency=true
        }
        //if (message["change-altitude"]!= null || message["vitals-state"]==0 )
        if ( vitalsEmergency==true && message["vitals-state"]==0 )
        {
          changeGauge()  //altitude change for vitals emergency
          vitalsEmergency=false
        }
      }, 1000);  // Fetch vitals state every 1 second



        const RADIUS = 90;
        const CIRCUMFERENCE = Math.PI * RADIUS;


        function getGaugeColor(value, type) {
            switch (type) {
                case "fuel":
                    if (value >= 75) return "green";
                    if (value >= 50) return "yellow";
                    if (value >= 25) return "orange";
                    return "red";
                case "altitude":
                    if (value < 100) return "red";
                    if (value < 5000) return "orange";
                    if (value <= 11000) return "green";
                    return "yellow";
                case "pressure":
                    if (value > 14.5) return "green";
                    if (value >= 13) return "yellow";
                    if (value >= 12) return "orange";
                    return "red";
                default:
                    return "gray";
            }
        }

        function updateGauge(value, arcId, pointerId, valueId, unit = '%', maxValue = 100, type = "fuel") {
            const percent = Math.min(1, Math.max(0, value / maxValue));
            const maxLength = 283;
            const offset = maxLength * (1 - percent);
            
            const arc = document.getElementById(arcId);
            const pointer = document.getElementById(pointerId);
            const valueText = document.getElementById(valueId);
            
            // Set Dasharray for smooth animations
            arc.style.strokeDasharray = `${CIRCUMFERENCE}`;
            arc.style.strokeDashoffset = `${offset}`;

            const color = getGaugeColor(value, type);

            arc.style.stroke = color;
            pointer.style.background = "white";
            valueText.innerText = `${Math.round(value)}${unit}`;

            const rotation = -90 + (180 * percent);
            pointer.style.transform = `translateX(-50%) rotate(${rotation}deg)`;

            // Fuel emergency handling
            if (fuelEmergency) {
                const warning = document.getElementById("fuelWarning");
                warning.classList.remove("hidden");
            }
        }


        

    let flightPhase = "ground";
    let altitude = 0;
    let fuel = 100;
    let pressure = 14.7;

    const MAX_ALTITUDE = 10000;
    const MIN_PRESSURE = 12.5;
    const NORMAL_PRESSURE = 14.7;

    // Simulated values
    let takeoff = 0;
    let approach_clear = 0;
    let fuelEmergency= false;

    function simulateFlight() {
        setInterval(() => {
            // Update values based on phase
            if (flightPhase === "takeoff") {
                altitude = Math.min(MAX_ALTITUDE, altitude + 400); // 400 ft per tick (~25fps)
                pressure = Math.max(MIN_PRESSURE, pressure - 0.05);
            } else if (flightPhase === "cruise") {
                // Hold steady
                pressure=14.7
                altitude=10000
            } else if (flightPhase === "descent") {
                altitude = Math.max(0, altitude - 400);
                pressure = Math.min(NORMAL_PRESSURE, pressure + 0.05);
            }

            // Fuel  decreases slowly
            fuel = Math.max(0, fuel - 0.03);
            // Fuel emergency 
            if(fuelEmergency) { 
                fuel = 0;
            }

            // Update UI
            updateGauge(fuel, "fuelArc", "fuelPointer", "fuelValue", '%', 100, "fuel");
            updateGauge(altitude, "altitudeArc", "altitudePointer", "altitudeValue", ' ft', MAX_ALTITUDE, "altitude");
            updateGauge(pressure, "pressureArc", "pressurePointer", "pressureValue", ' psi', NORMAL_PRESSURE, "pressure");
        }, 200); // ~5 times per second
    }

    simulateFlight();

        // Simulate external signals (can replace these with real-time server signals)
        function startTakeoff() {
            takeoff = 1;
            flightPhase = "takeoff";
            console.log("Takeoff started");

            setTimeout(() => {
                flightPhase = "cruise";
                console.log("Cruise started");
            }, 5000); // 5 seconds after takeoff
        }

        function beginDescent() {
            approach_clear = 1;
            flightPhase = "descent";
            console.log("Descent started");

            setTimeout(() => {
                flightPhase = "ground";
                altitude = 0;
                pressure = NORMAL_PRESSURE;
                console.log("Landed");
            }, 30000); // 30 seconds descent
        }

            // Simulate event triggers
           // setTimeout(startTakeoff, 2000);         // Takeoff in 2 seconds
           // setTimeout(beginDescent, 15000);        // Descent in 15 seconds from start


    document.getElementById("vitals-acknowledge-button").onclick = () => {
            logAction({ "action": "user acknowledged vitals prompt" })
            console.log('vitals logging acknowledged')
            document.getElementById('vitals').style.display = "none"
            bell.pause()
            //console.log("vitals completed time:", lastClicked)
        }
    </script>
    
</html>
