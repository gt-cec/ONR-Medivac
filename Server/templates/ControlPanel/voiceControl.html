<!DOCTYPE html>
<html lang="en">

    <meta charset="utf-8">
    <title>MK217 Voice Control</title>

    <!-- Ours -->
    <link rel="stylesheet" href="../static/HAIInterface/css/styling.css">
    <script src="/static/HAIInterface/JS/checklists.js"></script>
    <style>
        table {
            border-collapse: collapse;
          
        }
        th, td {
            border: 1px solid black;
            padding: 5px;
            font-size: large;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            width: 100%;
        }
        .table-button
        {
            background-color: palegreen; 
            border: 1px solid lightgrey;
            color:darkslategray;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: large;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 2px 2px 5px grey;
            width: 7vw;
            align-self: center;
        }
        .table-button:hover
        {
            border: none;
        }
    </style>
    

    <body>        
        <div id="topbar" class="topbar" style="justify-content: center">
            <div class="system-title">
                MK217 Voice<b>Control</b>
            </div>
        </div>

        <div id="center" class="center">
            <div class="main-content-container">
                <div id="title" class="general-title">Experimenter Voice Panel</div>
                <div class="control-container">
                    <div class="subcontent-container"  >
                            <table id="eventTable">
                                <caption><b>Radio Events Control</b></caption>
                                <tr>
                                    <th style="width:40%">Event</th>
                                    <th style="width:30%">Status</th>
                                    <th style="width:30%">Action</th>
                                </tr>
                            </table>

                        <!-- div id="regular-updates" class="control-button">Regular Updates</div>
                        <div id="preflight"  class="control-button">Preflight Response</div>
                        <div id="administer" class="control-button">Administer Medication Response</div> 
                        <div id="tank" class="control-button">Empty Fuel Tank Response</div>
                        <div id="engine" class="control-button">Engine Failure Response</div>
                        <div id="radioUpdate" class="control-button">Set Radio Update complete</div>
                        <div id="userRadio" class="control-button">Set status report</div>
                        <div id="userResp" class="control-button">Set response event </div> 
                        <div id="emergency" class="control-button">Set Emergency event </div>
                        <div id="reset" class="control-button">Reset all events </div> -->
                    </div>

                    <div class="subcontent-container" style="flex-grow:0;">
                        <b>Jarvis Control</b>
                        <div id="activate-jarvis" class="control-button" style="font-size: large;">Activate Jarvis</div>
                        <div id="deactivate-jarvis"  class="control-button" style="font-size: large;">Deactivate Jarvis</div>
                        <div id="EMpage" class="control-button" style="font-size: large;">Emergency Page</div>
                        <div id="CDpage" class="control-button" style="font-size: large;">Change Destination Page</div>
                        <div id="CApage" class="control-button" style="font-size: large;">Change Altitude Page</div>
                        <div id="RDpage" class="control-button" style="font-size: large;">Return to Departure Page</div>
                        <div id="mappage" class="control-button" style="font-size: large;">Open Map</div>
                        <label for="saytext">Enter text to say:</label><br>
                        <input type="text"id="saytext" name="saytext"><br>
                        <button id="sendtxt">Send</button>
                    </div>
                </div>
            </div>
        </div>    
    </body>

    <script>
   
        document.getElementById("activate-jarvis").onclick = async () => {
            await fetch("/ws", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ type: "activate_assistant"}), 
            });
        }

        document.getElementById("deactivate-jarvis").onclick = async () => {
            await fetch("/ws", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ type: "deactivate_assistant"}), 
            });
        }

       /*  document.getElementById("Empage").onclick = () => { fetch( '/hai-interface/change-destination?inflight=' + 1 + '&emergency=' + 1) }
        document.getElementById("CApage").onclick = () => { window.location.href = '/hai-interface/change-destination?inflight=' + 1 }
        document.getElementById("CApage").onclick = () => { window.location.href = '/hai-interface/change-altitude?Changed_altitude='+ 10000 }
        document.getElementById('mappage').href = '/hai-interface/map' */

        document.getElementById("sendtxt").onclick = async () => {
            sendText=document.getElementById("saytext").value
            await fetch("/speak", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ type: "say_text", text: sendText}), 
            });
        }


        document.getElementById("EMpage").onclick = async () => {
            await fetch("/var?emergency-page=1")
        }

        document.getElementById("CApage").onclick = async () => {
            await fetch("/var?ca-page=1")
        }

        document.getElementById("CDpage").onclick = async () => {
            await fetch("/var?cd-page=1")
        }

        document.getElementById("RDpage").onclick = async () => {
            await fetch("/var?rd-page=1")
        }
        
        document.getElementById("mappage").onclick = async () => {
            await fetch("/var?map_page=1")
        }

       /* document.getElementById('regular-updates').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "inflight_event", action:"toggle"}), 
            });
        }

         document.getElementById('emergency').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "emergency_event", action:"toggle"}), 
            });
        }

        document.getElementById('radioUpdate').onclick = async () => {
            choose=prompt("set or clear")
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "radioUpdateComplete", action:"toggle"}), 
            });
        }

        document.getElementById('userRadio').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "status_report", action:"toggle"}), 
            });
        }

        document.getElementById('userResp').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "response_event", action:"toggle"}), 
            });
        }
    
        document.getElementById('preflight').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "takeoff_event", action:"toggle"}), 
            });
        }
        document.getElementById('administer').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "administer_event", action:"toggle"}), 
            });
        }
        document.getElementById('tank').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "tank_event", action:"toggle"}), 
            });
        }
        document.getElementById('engine').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "engine_event", action:"toggle"}), 
            });
        }
        document.getElementById('reset').onclick = async () => {
            await fetch("/state", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'  // Inform the server that the request body contains JSON data
                },
                body: JSON.stringify({ event: "reset", action:"toggle"}), 
            });
        }



        setInterval(async () => {
            let vars = await fetch("/var").then((resp) => {return resp.json()})
            for (let key in vars) {
                // only change if the var maps to a div (prevents element not found errors)
                if (document.getElementById(key)) {
                    document.getElementById(key).innerHTML = vars[key]
                }
            }
        }, 500)
 */

        async function updateEventStates() {
            await fetch('/state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ event: "status_report",  action:"set" }),
            })
            .then((resp) => {
                // Check if the request was successful
                if (!resp.ok) {
                    throw new Error('Network response was not ok');
                }
                // Parse the response as JSON
                return resp.json();
                })
                .then((data) => {
                    console.log("received")

                    const table = document.getElementById('eventTable');
                    // Clear existing rows except header
                    while (table.rows.length > 1) {
                        table.deleteRow(1);
                    }
                    
                    // Add new rows based on the response
                    for (const [event, state] of Object.entries(data)) {
                        const row = table.insertRow();
                        const cellEvent = row.insertCell(0);
                        const cellStatus = row.insertCell(1);
                        const cellAction = row.insertCell(2);

                        cellEvent.textContent = event;
                        cellStatus.textContent = state ? 'Set' : 'Cleared';
                        
                        const button = document.createElement('button');
                        button.textContent = state ? 'clear' : 'set';
                        button.classList.add("table-button");
                        button.onclick = () => toggleEvent(event, button.textContent);
                        cellAction.appendChild(button);
                    }

                 })
                
                .catch(error =>{
                    console.error('Fetch error:', error);
                        })
                }
                    
        

        async function toggleEvent(event, newState) {
            await fetch(`/state`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ event: event, action: newState })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Event toggled:', data);
                updateEventStates();  // Refresh the table
            })
            .catch(error => console.error('Error:', error));
        }

        // Initial update
        updateEventStates();

        // Update every 2.5 seconds
        setInterval(updateEventStates, 2500);

    </script>

</html>     
